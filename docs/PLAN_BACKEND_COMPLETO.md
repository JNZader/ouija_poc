# Plan de Desarrollo Backend Iterativo - Ouija Virtual API

## Fecha: 2025-10-16
## Equipo: 2-4 Desarrolladores Backend
## Metodolog√≠a: H√≠brida Kanban + XP
## Duraci√≥n estimada: 4-6 semanas

---

# üìã RESUMEN EJECUTIVO

## Visi√≥n del Proyecto

**Ouija Virtual API** es una API REST y WebSocket que permite a aplicaciones frontend comunicarse con "esp√≠ritus" virtuales impulsados por IA. La API gestiona sesiones individuales y multiplayer, donde se procesan preguntas y se generan respuestas m√≠sticas mediante modelos de lenguaje (DeepSeek/Ollama).

## Propuesta de Valor

- **API RESTful** completa y bien documentada (OpenAPI/Swagger)
- **WebSockets** para comunicaci√≥n en tiempo real (multiplayer)
- **IA Integrada** con fallback inteligente
- **Arquitectura Simplificada** (1 servicio de IA vs 5)
- **Altamente Escalable** con Redis y PostgreSQL optimizado

## Objetivos del Proyecto

1. ‚úÖ Implementar arquitectura backend simplificada y optimizada
2. ‚úÖ API RESTful completa para chat individual
3. ‚úÖ WebSocket Gateway para multiplayer
4. ‚úÖ Integraci√≥n con Ollama (local) y DeepSeek (cloud)
5. ‚úÖ Sistema de fallback robusto
6. ‚úÖ Testing >80% coverage
7. ‚úÖ Documentaci√≥n completa (Swagger + Postman)

## M√©tricas de √âxito

| M√©trica | Objetivo |
|---------|----------|
| Tiempo de respuesta IA | < 3 segundos |
| Uptime del sistema | > 99.5% |
| Sesiones concurrentes | 100+ |
| Cobertura de tests | > 80% |
| Latencia WebSocket | < 100ms |

---

# üèóÔ∏è ARQUITECTURA T√âCNICA

## Stack Tecnol√≥gico Backend

### Core
- **Framework**: NestJS 10+ (TypeScript)
- **Runtime**: Node.js 18+
- **Package Manager**: npm

### Base de Datos
- **Relacional**: PostgreSQL 15+
- **ORM**: Prisma 5+
- **Cache**: Redis 7+

### Comunicaci√≥n
- **REST**: Express (integrado en NestJS)
- **WebSockets**: Socket.io + @nestjs/websockets
- **Documentaci√≥n**: Swagger/OpenAPI

### IA / LLM
- **Primario**: Ollama (local) - modelo qwen2.5:3b
- **Secundario**: DeepSeek API (cloud, opcional)
- **Fallback**: Templates en c√≥digo

### Testing
- **Unit Tests**: Jest
- **E2E Tests**: Supertest
- **Coverage**: Istanbul

### DevOps
- **Contenedores**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **Logs**: Winston
- **Monitoring**: Health checks + m√©tricas

## Arquitectura Simplificada

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (Otro equipo)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ HTTP REST + WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      BACKEND (NestJS)                        ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  OuijaController (REST)  ‚îÇ  MultiplayerGateway (WS)    ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ            ‚îÇ                               ‚îÇ                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ SpiritSessionService    ‚îÇ   ‚îÇ  MultiplayerService       ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ            ‚îÇ                                ‚îÇ                ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                        ‚îÇ                                     ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ            ‚îÇ  ConversationService      ‚îÇ (L√≥gica centralizada)
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                        ‚îÇ                                     ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ            ‚îÇ      AIService            ‚îÇ (Unificado)        ‚îÇ
‚îÇ            ‚îÇ  - DeepSeek API           ‚îÇ                    ‚îÇ
‚îÇ            ‚îÇ  - Ollama Local           ‚îÇ                    ‚îÇ
‚îÇ            ‚îÇ  - Fallback Templates     ‚îÇ                    ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                        ‚îÇ                                     ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ            ‚îÇ    PrismaService          ‚îÇ                    ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   PostgreSQL 15 (5 tablas)      ‚îÇ
        ‚îÇ  - spirits                       ‚îÇ
        ‚îÇ  - ouija_sessions                ‚îÇ
        ‚îÇ  - session_messages              ‚îÇ
        ‚îÇ  - multiplayer_rooms             ‚îÇ
        ‚îÇ  - room_participants             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Modelo de Datos Optimizado

### Diagrama ER

```
Spirit (7 campos)
  ‚îú‚îÄ 1:N ‚Üí OuijaSession (8 campos)
  ‚îÇ          ‚îî‚îÄ 1:N ‚Üí SessionMessage (7 campos)
  ‚îÇ          ‚îî‚îÄ N:1 ‚Üí MultiplayerRoom (10 campos)
  ‚îî‚îÄ 1:N ‚Üí MultiplayerRoom
               ‚îî‚îÄ 1:N ‚Üí RoomParticipant (8 campos)
```

### Caracter√≠sticas Clave
- ‚úÖ **5 tablas** (vs 7 en versi√≥n no optimizada)
- ‚úÖ **FK expl√≠citas** con CASCADE para integridad referencial
- ‚úÖ **Sin campos redundantes** (messageCount, currentPlayers se calculan din√°micamente)
- ‚úÖ **√çndices compuestos** para queries optimizadas
- ‚úÖ **Sin tablas no cr√≠ticas** (Response, QueryHistory eliminadas)

## Principios de Dise√±o

### 1. Simplicidad
- **1 servicio de IA** en lugar de 5 separados
- **L√≥gica centralizada** en ConversationService
- **Configuraci√≥n m√≠nima** (10 variables .env vs 20+)

### 2. DRY (Don't Repeat Yourself)
- L√≥gica de conversaci√≥n compartida entre single/multiplayer
- Templates de fallback en c√≥digo (no en BD)
- Prompts integrados en AIService

### 3. SOLID
- Single Responsibility: cada servicio tiene un prop√≥sito claro
- Dependency Injection: testeable y desacoplado
- Interface Segregation: DTOs espec√≠ficos por caso de uso

### 4. Testeable
- Inyecci√≥n de dependencias
- Servicios desacoplados
- Mocks f√°ciles de crear

---

# üéØ ROLES Y RESPONSABILIDADES

## Configuraci√≥n de Equipo Backend

### Equipo de 2 Devs
- **Dev 1 (Backend Lead)**: Arquitectura + Core Services + IA Integration
- **Dev 2 (Backend Dev)**: REST API + WebSockets + Testing

### Equipo de 3 Devs
- **Dev 1 (Backend Lead)**: Arquitectura + AIService + ConversationService
- **Dev 2 (API Dev)**: REST Controllers + DTOs + Validation
- **Dev 3 (Real-time Dev)**: WebSocket Gateway + Multiplayer + Redis

### Equipo de 4 Devs
- **Dev 1 (Backend Lead)**: Arquitectura + AIService
- **Dev 2 (API Dev)**: REST Controllers + SpiritSessionService
- **Dev 3 (Real-time Dev)**: WebSocket Gateway + MultiplayerService
- **Dev 4 (QA/DevOps)**: Testing + CI/CD + Monitoring

## Ceremonias √Ågiles

### Diarias
- **Daily Stand-up**: 15 min (async en Slack/Discord si remoto)
- **Formato**: ¬øQu√© hice? ¬øQu√© har√©? ¬øBloqueos?

### Semanales
- **Planning**: 1-2 horas (inicio de iteraci√≥n)
- **Review/Demo**: 1 hora (fin de iteraci√≥n)
- **Retrospectiva**: 30 min (fin de iteraci√≥n)

### Por Iteraci√≥n (1-2 semanas)
- **Refinement**: 1 hora (mitad de iteraci√≥n)
- **Pair Programming**: Ad-hoc seg√∫n necesidad
- **Code Review**: Continuo (PR reviews)

---

# üìä M√âTRICAS Y DEFINICI√ìN DE HECHO

## Definition of Done (DoD)

Una tarea est√° "Done" cuando:

‚úÖ **C√≥digo**
- [ ] Implementado seg√∫n criterios de aceptaci√≥n
- [ ] Code review aprobado por al menos 1 dev
- [ ] Sin warnings de ESLint/TSC
- [ ] Comentarios JSDoc en funciones p√∫blicas

‚úÖ **Testing**
- [ ] Tests unitarios escritos y pasando (>80% coverage)
- [ ] Tests de integraci√≥n para endpoints/servicios
- [ ] Tests E2E para flujos cr√≠ticos con Supertest
- [ ] Tests manuales documentados en Postman

‚úÖ **Documentaci√≥n**
- [ ] Swagger/OpenAPI actualizado para endpoints
- [ ] Comentarios JSDoc en funciones p√∫blicas
- [ ] README actualizado si aplica
- [ ] Changelog actualizado

‚úÖ **Deploy**
- [ ] Merge a rama de desarrollo
- [ ] CI/CD pipeline pasando
- [ ] Smoke tests pasando

## Velocity Tracking

### Story Points
- **1 punto** = 1-2 horas (tarea trivial)
- **2 puntos** = 3-4 horas (tarea peque√±a)
- **3 puntos** = 5-8 horas (tarea mediana)
- **5 puntos** = 1-2 d√≠as (tarea grande)
- **8 puntos** = 2-3 d√≠as (√©pica peque√±a, dividir)

### Capacity por Iteraci√≥n (1 semana)
- **2 devs**: 20-25 puntos
- **3 devs**: 30-40 puntos
- **4 devs**: 40-50 puntos

---

# üóìÔ∏è CRONOGRAMA GENERAL

## Vista de Alto Nivel

| Iteraci√≥n | Duraci√≥n | Objetivo Principal | Story Points |
|-----------|----------|-------------------|--------------|
| **Iteraci√≥n 0** | 2-3 d√≠as | Setup + Arquitectura Base | 12-15 |
| **Iteraci√≥n 1** | 1-2 semanas | Core Services + IA Integration | 25-30 |
| **Iteraci√≥n 2** | 1 semana | REST API Completa | 20-25 |
| **Iteraci√≥n 3** | 1-2 semanas | WebSockets + Multiplayer | 30-35 |
| **Iteraci√≥n 4** | 3-5 d√≠as | Testing + Polish | 15-20 |
| **Iteraci√≥n 5** | 2-3 d√≠as | Deploy + Monitoring | 10-15 |

**Total**: 4-6 semanas (20-30 d√≠as laborables)

---

# üöÄ PLAN DE ITERACIONES DETALLADO

## Entregables por Iteraci√≥n

### Iteraci√≥n 0: Fundaci√≥n (2-3 d√≠as)
- ‚úÖ Repositorio Git configurado
- ‚úÖ NestJS con estructura modular funcionando
- ‚úÖ PostgreSQL + Prisma configurado con schema optimizado
- ‚úÖ Redis configurado
- ‚úÖ Docker Compose listo
- ‚úÖ CI/CD b√°sico
- ‚úÖ Endpoint `/health` funcionando

### Iteraci√≥n 1: Backend Core (1-2 semanas)
- ‚úÖ AIService unificado funcionando
- ‚úÖ ConversationService operativo
- ‚úÖ PrismaService configurado
- ‚úÖ Integraci√≥n con Ollama
- ‚úÖ Integraci√≥n con DeepSeek (opcional)
- ‚úÖ Sistema de fallback
- ‚úÖ Tests unitarios >80%

### Iteraci√≥n 2: REST API (1 semana)
- ‚úÖ SpiritSessionService completo
- ‚úÖ Todos los endpoints REST funcionando:
  - GET /api/ouija/spirits
  - POST /api/ouija/session/create
  - POST /api/ouija/session/ask
  - POST /api/ouija/session/:token/end
  - GET /api/ouija/session/:token/history
- ‚úÖ Validaci√≥n con class-validator
- ‚úÖ Swagger completamente documentado
- ‚úÖ Postman collection
- ‚úÖ Tests E2E

### Iteraci√≥n 3: Multiplayer (1-2 semanas)
- ‚úÖ WebSocket Gateway funcionando
- ‚úÖ MultiplayerService operativo
- ‚úÖ Sistema de salas multiplayer
- ‚úÖ Sincronizaci√≥n en tiempo real
- ‚úÖ Redis para gesti√≥n de salas
- ‚úÖ Tests de integraci√≥n WebSocket

### Iteraci√≥n 4: Testing & Polish (3-5 d√≠as)
- ‚úÖ Cobertura de tests >80%
- ‚úÖ Tests E2E completos
- ‚úÖ Error handling robusto
- ‚úÖ Logging estructurado (Winston)
- ‚úÖ Performance optimizado
- ‚úÖ Documentaci√≥n completa

### Iteraci√≥n 5: Deploy & Monitoring (2-3 d√≠as)
- ‚úÖ Dockerfile optimizado
- ‚úÖ Docker Compose para producci√≥n
- ‚úÖ CI/CD pipeline completo
- ‚úÖ Health checks avanzados
- ‚úÖ M√©tricas y monitoring
- ‚úÖ Backups configurados
- ‚úÖ Runbook operativo

---

# üì¶ API ENDPOINTS COMPLETOS

## REST API

### Health & Status
```
GET /api/health
GET /api/health/detailed
```

### Spirits
```
GET /api/ouija/spirits
GET /api/ouija/spirits/:id
```

### Sessions (Individual)
```
POST /api/ouija/session/create
POST /api/ouija/session/ask
POST /api/ouija/session/:token/end
GET  /api/ouija/session/:token/history
GET  /api/ouija/session/:token/status
```

### Multiplayer Rooms
```
POST /api/multiplayer/room/create
POST /api/multiplayer/room/join
POST /api/multiplayer/room/:code/leave
GET  /api/multiplayer/room/:code
GET  /api/multiplayer/rooms/active
```

## WebSocket Events

### Cliente ‚Üí Servidor
```
create-room      { spiritId, userId, username }
join-room        { roomCode, userId, username }
leave-room       { roomCode, userId }
send-message     { roomCode, userId, username, message }
```

### Servidor ‚Üí Cliente
```
room-created     { roomCode, spirit, participants }
room-joined      { participants }
user-joined      { username, participants }
user-left        { username, participants }
new-message      { role, username?, content, timestamp }
room-ended       { reason }
```

---

# üìö STACK DE DEPENDENCIAS

## Dependencias de Producci√≥n

```json
{
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "@nestjs/platform-express": "^10.0.0",
    "@nestjs/platform-socket.io": "^10.0.0",
    "@nestjs/websockets": "^10.0.0",
    "@nestjs/config": "^3.0.0",
    "@nestjs/swagger": "^7.0.0",
    "@prisma/client": "^5.0.0",
    "prisma": "^5.0.0",
    "class-validator": "^0.14.0",
    "class-transformer": "^0.5.1",
    "socket.io": "^4.6.0",
    "redis": "^4.6.0",
    "winston": "^3.11.0"
  }
}
```

## Dependencias de Desarrollo

```json
{
  "devDependencies": {
    "@nestjs/cli": "^10.0.0",
    "@nestjs/schematics": "^10.0.0",
    "@nestjs/testing": "^10.0.0",
    "@types/node": "^20.0.0",
    "@types/jest": "^29.5.0",
    "@types/supertest": "^2.0.12",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "eslint": "^8.42.0",
    "eslint-config-prettier": "^9.0.0",
    "jest": "^29.5.0",
    "prettier": "^3.0.0",
    "supertest": "^6.3.0",
    "ts-jest": "^29.1.0",
    "ts-node": "^10.9.1",
    "typescript": "^5.1.3"
  }
}
```

---

# üéì ONBOARDING PARA NUEVOS DESARROLLADORES

## D√≠a 1: Setup Local (2-3 horas)

### Prerequisitos
```bash
# Verificar versiones
node --version    # v18+ requerido
npm --version     # v9+ requerido
docker --version  # v24+ requerido
git --version     # v2.30+ requerido
```

### Setup Paso a Paso

1. **Clonar repositorio**
```bash
git clone <repo-url>
cd ouija-virtual-backend
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar .env**
```bash
cp .env.example .env
# Editar DATABASE_URL, OLLAMA_URL, etc.
```

4. **Levantar infraestructura**
```bash
docker-compose up -d postgres redis
```

5. **Ejecutar migraciones**
```bash
npx prisma migrate dev
npx prisma generate
npx prisma db seed
```

6. **Iniciar servidor**
```bash
npm run start:dev
```

7. **Verificar**
```bash
# Health check
curl http://localhost:3000/api/health

# Swagger
open http://localhost:3000/api/docs

# Prisma Studio
npx prisma studio
```

## D√≠a 2: Exploraci√≥n de C√≥digo (2-3 horas)

### Lectura Recomendada (en orden)

1. **Arquitectura** (30 min)
   - `README.md`
   - `ARQUITECTURA_SIMPLIFICADA.md`
   - Este archivo (`PLAN_BACKEND_COMPLETO.md`)

2. **C√≥digo Core** (1.5 horas)
   - `src/main.ts` - Entry point
   - `src/modules/ouija/ouija.module.ts`
   - `src/modules/ouija/services/ai.service.ts`
   - `src/modules/ouija/services/conversation.service.ts`
   - `src/modules/ouija/controllers/ouija.controller.ts`
   - `prisma/schema.prisma`

3. **Tests** (30 min)
   - `src/modules/ouija/services/__tests__/ai.service.spec.ts`
   - `test/e2e/ouija.e2e-spec.ts`

### Ejercicio Pr√°ctico

**Objetivo**: Implementar un endpoint simple

**Tarea**: Agregar endpoint `GET /api/ouija/stats` que retorne:
- Total de sesiones activas
- Total de mensajes enviados hoy
- Esp√≠ritu m√°s consultado

**Tiempo estimado**: 2-3 horas

---

# üìö RECURSOS Y REFERENCIAS

## Documentaci√≥n T√©cnica
- [NestJS Docs](https://docs.nestjs.com)
- [Prisma Docs](https://www.prisma.io/docs)
- [Socket.io Docs](https://socket.io/docs/v4)
- [Swagger Docs](https://swagger.io/docs/)

## Convenciones de C√≥digo

### Commits
```
feat: agregar endpoint para estad√≠sticas
fix: corregir validaci√≥n en SessionDTO
docs: actualizar README con nuevos endpoints
test: agregar tests para AIService
refactor: simplificar l√≥gica de ConversationService
perf: optimizar query de mensajes
```

### Branches
```
main           - Producci√≥n
develop        - Desarrollo
feature/US-123-nombre  - Features nuevas
bugfix/456-bug-name    - Correcci√≥n de bugs
hotfix/789-critical    - Fixes urgentes en prod
```

---

# ‚ö†Ô∏è RIESGOS Y MITIGACIONES

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|--------------|---------|------------|
| Ollama no disponible/lento | Media | Alto | Fallback a DeepSeek + templates |
| Performance en multiplayer | Media | Medio | Load testing desde iteraci√≥n 3 |
| Complejidad WebSockets | Media | Medio | Spike t√©cnico en iteraci√≥n 2.5 |
| Scope creep | Alta | Alto | Backlog priorizado, decir NO |
| Bugs en producci√≥n | Media | Alto | Tests >80%, staging environment |
| Sincronizaci√≥n Redis | Baja | Medio | Retry logic + health checks |

---

# üéâ CONCLUSI√ìN

Este plan proporciona una ruta clara y ejecutable para desarrollar el backend de Ouija Virtual desde cero. La arquitectura simplificada reduce la complejidad t√©cnica en ~50% comparado con el enfoque tradicional de 5 servicios de IA separados.

## Siguientes Pasos Inmediatos

1. ‚úÖ **Leer iteraci√≥n 0**: Ver archivo separado con detalles t√©cnicos
2. ‚úÖ **Crear repositorio Git**
3. ‚úÖ **Configurar proyecto seg√∫n iteraci√≥n 0**
4. ‚úÖ **Primera daily stand-up**
5. ‚úÖ **Comenzar desarrollo**

## Archivos de Referencia

- `ITERACION_0_BACKEND.md` - Setup inicial detallado
- `ITERACIONES_BACKEND.md` - Iteraciones 1-5 detalladas
- `GUIA_BACKEND_RAPIDA.md` - Quick start y troubleshooting

**¬°Buena suerte con el desarrollo del backend! üöÄ**
